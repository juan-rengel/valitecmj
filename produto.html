<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ValiTec MJ â€” Cadastro de Produto</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;500;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="dashboard.css">
</head>
<body>
  <canvas id="particleCanvas"></canvas>

  <div class="app-container">
    <aside class="sidebar">
      <h1>ValiTec MJ</h1>
      <nav>
        <a href="dashboard.html">Painel</a>
        <a href="#" class="active">
            cadastrar produtos
        </a>
        <a href="Lista-produtos.html">lista de produto</a>
        <a href="Lista-rebaixados.html">Produtos rebaixado</a>
        <a href="calendario.html">Calendario</a>
        <a href="perfil.html">Perfil</a>
        <a href="cadastro-usuarios.html">Cadastrar UsuÃ¡rios</a>
        <a href="relatorios.html">RelatÃ³rios</a>
        <a href="#" onclick="localStorage.clear(); location.href='index.html'">Sair</a>
      </nav>
    </aside>

    <main class="main">
      <h2 id="tituloPagina" style="text-align:center;">Cadastrar Produto</h2>

      <form id="formProduto" class="form-produto">

        <label>Nome do Produto</label>
        <input type="text" id="nome" required>

        <label>CÃ³digo de Barras</label>
<div style="display:flex; gap:8px;">
  <input type="text" id="codigo" placeholder="Aguardando leitura..." required style="flex:1;">
  <button type="button" id="btnScan" style="padding:6px 12px;border-radius:6px;background:var(--accent);border:none;cursor:pointer;">ðŸ“· Ler</button>
</div>

<video id="scannerPreview" style="display:none;width:260px;border-radius:8px;margin-top:8px;border:1px solid rgba(255,255,255,0.4);"></video>

        <label>Lote</label>
        <input type="text" id="lote" required>

        <label>Setor</label>
        <select id="setor" required>
          <option value="Mercearia">Mercearia</option>
          <option value="Bebidas">Bebidas</option>
          <option value="Frios">Frios</option>
          <option value="Higiene">Higiene</option>
          <option value="Limpeza">Limpeza</option>
          <option value="AÃ§ougue">AÃ§ougue</option>
        </select>

        <label>Data de Validade</label>
        <input type="date" id="validade" required>

        <label>Foto do Produto</label>
        <div class="foto-area">
          <video id="cameraPreview" autoplay playsinline style="display:none;width:260px;border-radius:8px;border:1px solid rgba(255,255,255,0.3);"></video>
          <img id="previewFoto" style="display:none;width:140px;border-radius:6px;border:1px solid rgba(255,255,255,0.3);" />
          <input type="file" id="foto" accept="image/*" style="display:none;" />

          <button type="button" id="btnOpenCamera">ðŸ“· Abrir CÃ¢mera</button>
          <button type="button" id="btnCapturar" style="display:none;">âœ… Capturar Foto</button>
        </div>

        <button type="submit" class="btnSalvar" id="btnSalvar">Salvar Produto</button>
        <button type="button" id="btnLimpar" class="btnEdit" style="background:#555;border:none;">Limpar Campos</button>

      </form>
    </main>
  </div>

  <!-- Biblioteca do leitor de cÃ³digo de barras -->
<script src="https://unpkg.com/@zxing/browser@0.1.1"></script>

<script>
let stream;
const cameraPreview = document.getElementById('cameraPreview');
const previewFoto = document.getElementById('previewFoto');
const inputFoto = document.getElementById('foto');
const btnOpenCamera = document.getElementById('btnOpenCamera');
const btnCapturar = document.getElementById('btnCapturar');

btnOpenCamera.onclick = async () => {
  try {
    // Lista todos os dispositivos de vÃ­deo
    const devices = await navigator.mediaDevices.enumerateDevices();
    const cameras = devices.filter(d => d.kind === "videoinput");

    if (cameras.length === 0) {
      alert("Nenhuma cÃ¢mera encontrada no dispositivo.");
      return;
    }

    // Tenta identificar cÃ¢mera traseira
    let cameraId = cameras.find(c => c.label.toLowerCase().includes("back") || c.label.toLowerCase().includes("traseira"))?.deviceId;

    // Se nÃ£o achar traseira â†’ pega a Ãºltima (geralmente Ã© a traseira mesmo)
    if (!cameraId) cameraId = cameras[cameras.length - 1].deviceId;

    stream = await navigator.mediaDevices.getUserMedia({
      video: { deviceId: { exact: cameraId } },
      audio: false
    });

    cameraPreview.srcObject = stream;
    cameraPreview.style.display = 'block';
    previewFoto.style.display = 'none';
    btnCapturar.style.display = 'inline-block';

  } catch (e) {
    alert("NÃ£o foi possÃ­vel acessar a cÃ¢mera. DÃª permissÃ£o ao aplicativo nas configuraÃ§Ãµes.");
    console.log(e);
  }
};

btnCapturar.onclick = () => {
  const canvas = document.createElement('canvas');
  canvas.width = cameraPreview.videoWidth;
  canvas.height = cameraPreview.videoHeight;
  canvas.getContext('2d').drawImage(cameraPreview, 0, 0);

  const dataURL = canvas.toDataURL("image/jpeg");
  previewFoto.src = dataURL;
  previewFoto.style.display = 'block';

  fetch(dataURL).then(r => r.blob()).then(b => {
    const dt = new DataTransfer();
    dt.items.add(new File([b], "produto.jpg", { type: "image/jpeg" }));
    inputFoto.files = dt.files;
  });

  if (stream) stream.getTracks().forEach(t => t.stop());
  cameraPreview.style.display = "none";
  btnCapturar.style.display = "none";
};
</script>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
import { getFirestore, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";
import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-storage.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";

const firebaseConfig = {
  apiKey: "AIzaSyDPIlkTLbaeUiuvfvijWf5fofREw5oE8ic",
  authDomain: "valitec-mj.firebaseapp.com",
  projectId: "valitec-mj",
  storageBucket: "valitec-mj.firebasestorage.app",
  messagingSenderId: "616592039657",
  appId: "1:616592039657:web:3827a890474111be85da78"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const storage = getStorage(app);
const auth = getAuth(app);

const params = new URLSearchParams(location.search);
const produtoId = params.get("id");

// --- MODO EDIÃ‡ÃƒO ---
onAuthStateChanged(auth, async user => {
  if (!user || !produtoId) return;

  document.getElementById("tituloPagina").textContent = "Editar Produto";
  document.getElementById("btnSalvar").textContent = "Salvar AlteraÃ§Ãµes";

  const snapUser = await getDoc(doc(db, "usuarios", user.email));
  const loja = snapUser.data().loja;

  const prodSnap = await getDoc(doc(db, `lojas/${loja}/produtos/${produtoId}`));
  const p = prodSnap.data();

  nome.value = p.nome;
  codigo.value = p.codigo;
  lote.value = p.lote;
  setor.value = p.setor;
  validade.value = p.dataValidadeISO;
  previewFoto.src = p.fotoURL;
  previewFoto.style.display = "block";
  document.getElementById("foto").required = false;
});

// --- SALVAR ---
formProduto.onsubmit = async (e) => {
  e.preventDefault();

  const user = auth.currentUser;
  const snapUser = await getDoc(doc(db, "usuarios", user.email));
  const loja = snapUser.data().loja;

  const nomeProduto = nome.value.trim();
  const codigoProduto = codigo.value.trim();
  const loteProduto = lote.value.trim();
  const setorProduto = setor.value;
  const validadeProduto = validade.value;

  const [yyyy, mm, dd] = validadeProduto.split("-");
  const validadeBR = `${dd}/${mm}/${yyyy}`;

  let fotoURLFinal = previewFoto.src;

  if (inputFoto.files.length > 0) {
    const fotoRef = ref(storage, `${loja}/${produtoId || Date.now()}.jpg`);
    await uploadBytes(fotoRef, inputFoto.files[0]);
    fotoURLFinal = await getDownloadURL(fotoRef);
  }

  const id = produtoId || Date.now().toString();

  await setDoc(doc(db, `lojas/${loja}/produtos/${id}`), {
    nome: nomeProduto,
    codigo: codigoProduto,
    lote: loteProduto,
    setor: setorProduto,
    dataValidadeISO: validadeProduto,
    dataValidadeBR: validadeBR,
    fotoURL: fotoURLFinal,
    status: "normal",
    criadoEm: new Date()
  }, { merge: true });

  location.href = "lista-produtos.html";
};
// âœ… ESTE AQUI Ã‰ O BOTÃƒO LIMPAR
document.getElementById("btnLimpar").onclick = () => {
  formProduto.reset();
  previewFoto.style.display = "none";
  scannerPreview.style.display = "none";
};
</script>
<script>
const sidebar = document.querySelector('.sidebar');
const hamburger = document.createElement('button');
hamburger.className = 'hamburger';
hamburger.textContent = 'â˜°';
hamburger.onclick = () => {
  sidebar.classList.toggle('open');
};
document.body.appendChild(hamburger);
</script>
<button id="toggleTheme" class="theme-toggle">ðŸŒ™</button>
<script>
const toggle = document.getElementById("toggleTheme");

function aplicarTema() {
  const tema = localStorage.getItem("temaValitec") || "dark";
  if (tema === "light") {
    document.documentElement.classList.add("light-mode");
    toggle.textContent = "ðŸŒ™";
  } else {
    document.documentElement.classList.remove("light-mode");
    toggle.textContent = "ðŸ”†";
  }
}

toggle.onclick = () => {
  const atual = localStorage.getItem("temaValitec") || "dark";
  const novo = (atual === "dark") ? "light" : "dark";
  localStorage.setItem("temaValitec", novo);
  aplicarTema();
};

aplicarTema();
</script>
</body>
</html>