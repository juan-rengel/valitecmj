<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ValiTec MJ â€” Produtos Rebaixados</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;500;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="dashboard.css">
</head>
<body>
  <canvas id="particleCanvas"></canvas>

  <div class="app-container">
    <aside class="sidebar">
      <h1>ValiTec MJ</h1>
      <nav>
        <a href="dashboard.html">Painel</a>
        <a href="produtos.html">Cadastrar Produto</a>
        <a href="lista-produtos.html">Lista de Produtos</a>
        <a href="Lista-rebaixados.html" class="active">Produtos Rebaixados</a>
        <a href="calendario.html">CalendÃ¡rio</a>
        <a href="perfil.html">Perfil</a>
        <a href="#" onclick="localStorage.clear(); location.href='index.html'">Sair</a>
      </nav>
    </aside>

    <main class="main">
      <h2 style="text-align:center;">Produtos Rebaixados</h2>

      <!-- ðŸ” CAMPO DE BUSCA -->
      <input type="text" id="buscaRebaixado" placeholder="ðŸ” Buscar por nome..." 
      style="margin-bottom: 16px; padding: 10px; width:100%; border-radius:12px; border:1px solid rgba(255,255,255,0.25); background:rgba(20,28,47,0.45); color:white; outline:none;">

      <div id="listaRebaixados" class="lista-produtos"></div>
    </main>
  </div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
import { getFirestore, collection, query, where, getDocs, doc, getDoc, updateDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";
import { getAuth } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";

const firebaseConfig = {
  apiKey: "AIzaSyDPIlkTLbaeUiuvfvijWf5fofREw5oE8ic",
  authDomain: "valitec-mj.firebaseapp.com",
  projectId: "valitec-mj",
  storageBucket: "valitec-mj.firebasestorage.app",
  messagingSenderId: "616592039657",
  appId: "1:616592039657:web:3827a890474111be85da78"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);

let itens = []; // lista para filtro

async function carregarRebaixados() {
  const user = auth.currentUser;
  if (!user) return;

  const userSnap = await getDoc(doc(db, "usuarios", user.email));
  const loja = userSnap.data().loja;

  const q = query(collection(db, `lojas/${loja}/produtos`), where("status", "==", "rebaixado"));
  const snap = await getDocs(q);

  itens = [];
  snap.forEach(d => itens.push({ id: d.id, ...d.data(), loja }));

  exibirLista(itens);
}

function exibirLista(lista) {
  const div = document.getElementById("listaRebaixados");
  div.innerHTML = "";

  lista.forEach(p => {
    const card = document.createElement("div");
    card.className = "produto-card";
    card.style.border = "1px solid #4eff9a";

    card.innerHTML = `
      <img src="${p.fotoURL}" style="width:70px;border-radius:6px;">
      <div style="flex:1;">
        <strong>${p.nome}</strong><br>
        ${p.setor}<br>
        Validade: ${p.dataValidadeBR}<br>
        <span style="color:#4eff9a;font-weight:bold;">âœ… REBAIXADO</span>
      </div>
    `;

    // ðŸ”„ Reverter
    const btnReverter = document.createElement("button");
    btnReverter.textContent = "â†©ï¸ Reverter";
    btnReverter.className = "btnConfirm";
    btnReverter.style.background = "#4eff9a";
    btnReverter.style.color = "#000";
    btnReverter.onclick = async () => {
      await updateDoc(doc(db, `lojas/${p.loja}/produtos/${p.id}`), { status: "normal" });
      carregarRebaixados();
    };

    // ðŸ—‘ï¸ Excluir
    const btnExcluir = document.createElement("button");
    btnExcluir.textContent = "ðŸ—‘ï¸ Excluir";
    btnExcluir.className = "btnConfirm";
    btnExcluir.style.background = "#ff5c5c";
    btnExcluir.style.color = "#000";
    btnExcluir.onclick = async () => {
      if (confirm(`Excluir definitivamente ${p.nome}?`)) {
        await deleteDoc(doc(db, `lojas/${p.loja}/produtos/${p.id}`));
        carregarRebaixados();
      }
    };

    card.appendChild(btnReverter);
    card.appendChild(btnExcluir);
    div.appendChild(card);
  });
}

// ðŸ” FILTRO EM TEMPO REAL
document.getElementById("buscaRebaixado").addEventListener("input", e => {
  const termo = e.target.value.toLowerCase();
  exibirLista(itens.filter(p => p.nome.toLowerCase().includes(termo)));
});

auth.onAuthStateChanged(carregarRebaixados);
</script>

<script>
// MENU HAMBÃšRGUER
const sidebar = document.querySelector('.sidebar');
const hamburger = document.createElement('button');
hamburger.className = 'hamburger';
hamburger.textContent = 'â˜°';
hamburger.onclick = () => sidebar.classList.toggle('open');
document.body.appendChild(hamburger);
</script>

</body>
</html>
