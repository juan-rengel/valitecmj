<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ValiTec MJ ‚Äî Dashboard</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;500;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="dashboard.css">
</head>

<body>
  <canvas id="particleCanvas"></canvas>

  <div class="app-container">
    <aside class="sidebar">
      <nav>
        <a href="#" class="active">Painel</a>
        <a href="produto.html">Cadastrar Produtos</a>
        <a href="Lista-produtos.html">Lista de Produtos</a>
        <a href="Lista-rebaixados.html">Produtos Rebaixados</a>
        <a href="calendario.html">Calend√°rio</a>
        <a href="perfil.html">Perfil</a>
        <a href="cadastro-usuarios.html">Cadastrar Usu√°rios</a>
        <a href="#" onclick="localStorage.clear(); location.href='index.html'">Sair</a>
      </nav>
    </aside>

    <main class="main">
      <h2 style="text-align:center; margin-bottom: 15px;">Painel de Indicadores</h2>

      <!-- Cards -->
      <div class="cards">
        <div class="card"><span class="icon">‚è≥</span><span class="number" id="pertoVencer">0</span><span class="label">Perto de Vencer</span></div>
        <div class="card"><span class="icon">üìÖ</span><span class="number" id="vencendoHoje">0</span><span class="label">Vencendo Hoje</span></div>
        <div class="card"><span class="icon">‚ö†Ô∏è</span><span class="number" id="vencidos">0</span><span class="label">Vencidos</span></div>
        <div class="card"><span class="icon">üì¶</span><span class="number" id="totalProdutos">0</span><span class="label">Total de Produtos</span></div>
        <div class="card resumo-card" id="abrirSetor"><span class="icon">üè∑Ô∏è</span><span class="number">+</span><span class="label">Resumo por Setor</span></div>
      </div>
    </main>
  </div>

  <!-- Modal Resumo por Setor -->
  <div id="modalSetor" class="modal" style="display:none;">
    <div style="background:rgba(15,25,45,0.96); border:1px solid var(--accent);
                padding:20px; border-radius:12px; width:360px; max-width:90vw;">
      <h3 style="text-align:center;margin-bottom:12px;">Resumo por Setor</h3>
      <canvas id="graficoSetoresModal" style="max-width:100%;"></canvas>
      <button id="fecharSetor" style="margin-top:15px;width:100%;padding:10px;
              border:none;border-radius:10px;background:var(--accent);
              color:#000;font-weight:700;cursor:pointer;">Fechar</button>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
  import { getFirestore, collection, getDocs, doc, getDoc } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";
  import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";

  const firebaseConfig = {
    apiKey: "AIzaSyDPIlkTLbaeUiuvfvijWf5fofREw5oE8ic",
    authDomain: "valitec-mj.firebaseapp.com",
    projectId: "valitec-mj",
    storageBucket: "valitec-mj.firebasestorage.app",
    messagingSenderId: "616592039657",
    appId: "1:616592039657:web:3827a890474111be85da78"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  const auth = getAuth(app);

  let lojaAtual = null;
  let graficoSetor = null;

  // === Carregar loja do usu√°rio logado ===
  onAuthStateChanged(auth, async (user) => {
    if (!user) return;
    const snap = await getDoc(doc(db, "usuarios", user.email));
    if (!snap.exists()) return;
    lojaAtual = snap.data().loja;

    carregarIndicadores();
  });

  // === Indicadores principais ===
  async function carregarIndicadores() {
    if (!lojaAtual) return;
    const ref = collection(db, `lojas/${lojaAtual}/produtos`);
    const snap = await getDocs(ref);

    let total = 0, vencidos = 0, vencendoHoje = 0, pertoVencer = 0;
    const hoje = new Date();
    snap.forEach(docItem => {
      const p = docItem.data();
      if (!p.dataValidadeISO) return;
      total++;
      const validade = new Date(p.dataValidadeISO);
      const diff = Math.ceil((validade - hoje) / (1000 * 60 * 60 * 24));

      if (diff < 0) vencidos++;
      else if (diff === 0) vencendoHoje++;
      else if (diff <= 5) pertoVencer++;
    });

    document.getElementById("totalProdutos").textContent = total;
    document.getElementById("vencidos").textContent = vencidos;
    document.getElementById("vencendoHoje").textContent = vencendoHoje;
    document.getElementById("pertoVencer").textContent = pertoVencer;
  }

  // === Gr√°fico Resumo por Setor ===
  async function abrirResumoSetor() {
    if (!lojaAtual) return alert("Loja n√£o identificada.");
    const modal = document.getElementById("modalSetor");
    modal.style.display = "flex";

    const ref = collection(db, `lojas/${lojaAtual}/produtos`);
    const snap = await getDocs(ref);

    const setores = {};
    snap.forEach(docItem => {
      const p = docItem.data();
      if (!p.setor) return;
      setores[p.setor] = (setores[p.setor] || 0) + 1;
    });

    const ctx = document.getElementById("graficoSetoresModal").getContext("2d");
    if (graficoSetor) graficoSetor.destroy();

    graficoSetor = new Chart(ctx, {
      type: 'doughnut',
      data: {
        labels: Object.keys(setores),
        datasets: [{
          data: Object.values(setores),
          backgroundColor: ["#00C8FF","#4EFF9A","#FFD700","#FF6B6B","#9B5DE5","#F15BB5","#00BBF9"]
        }]
      },
      options: {
        plugins: { legend: { labels: { color: '#fff' } } }
      }
    });
  }

  document.getElementById("abrirSetor").addEventListener("click", abrirResumoSetor);
  document.getElementById("fecharSetor").addEventListener("click", () => {
    document.getElementById("modalSetor").style.display = "none";
  });
  </script>

  <script>
  // --- Menu Hamb√∫rguer ---
  const sidebar = document.querySelector('.sidebar');
  const hamburger = document.createElement('button');
  hamburger.className = 'hamburger';
  hamburger.textContent = '‚ò∞';
  hamburger.onclick = () => sidebar.classList.toggle('open');
  document.body.appendChild(hamburger);

  // --- Fundo de part√≠culas ---
  const canvas = document.getElementById('particleCanvas');
  if (canvas) {
    const ctx = canvas.getContext('2d');
    function resize(){ canvas.width = innerWidth; canvas.height = innerHeight; }
    window.addEventListener('resize', resize); resize();
    const particles = Array.from({length:60},()=>({
      x:Math.random()*canvas.width,y:Math.random()*canvas.height,r:Math.random()*2+1,
      sx:(Math.random()-0.5)*0.6,sy:(Math.random()-0.5)*0.6
    }));
    function animate(){
      ctx.clearRect(0,0,canvas.width,canvas.height);
      particles.forEach(p=>{
        p.x+=p.sx;p.y+=p.sy;
        if(p.x<0)p.x=canvas.width;if(p.x>canvas.width)p.x=0;
        if(p.y<0)p.y=canvas.height;if(p.y>canvas.height)p.y=0;
        ctx.fillStyle='rgba(255,255,255,0.07)';
        ctx.beginPath();ctx.arc(p.x,p.y,p.r,0,Math.PI*2);ctx.fill();
      });
      requestAnimationFrame(animate);
    }
    animate();
  }

  // --- Tema Claro/Escuro ---
  const toggle = document.createElement("button");
  toggle.id = "toggleTheme";
  toggle.className = "theme-toggle";
  toggle.textContent = "üåô";
  document.body.appendChild(toggle);

  function aplicarTema() {
    const tema = localStorage.getItem("temaValitec") || "dark";
    if (tema === "light") {
      document.documentElement.classList.add("light-mode");
      toggle.textContent = "üåô";
    } else {
      document.documentElement.classList.remove("light-mode");
      toggle.textContent = "üîÜ";
    }
  }
  toggle.onclick = () => {
    const atual = localStorage.getItem("temaValitec") || "dark";
    const novo = (atual === "dark") ? "light" : "dark";
    localStorage.setItem("temaValitec", novo);
    aplicarTema();
  };
  aplicarTema();
  </script>
</body>
</html>
