<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ValiTec MJ ‚Äî Dashboard</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;500;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="dashboard.css">
</head>
<body>
  <canvas id="particleCanvas"></canvas>

  <div class="app-container">
    <aside class="sidebar">
    
   <nav>
        <a href="#" class="active">Painel</a>
        <a href="produto.html">
            cadastrar produtos
        </a>
        <a href="lista-produto.html">Lista de produtos</a>
        <a href="Lista-rebaixados.html">Produtos Rebaixados</a>
        <a href="calendario.html">Calendario</a>
        <a href="perfil.html">Perfil</a>
        <a href="cadastro-usuarios.html">Cadastrar Usu√°rios</a>
        <a href="#" onclick="localStorage.clear(); location.href='index.html'">Sair</a>
      </nav>
</aside>


   <main class="main">

  <h2 style="text-align:center; margin-bottom: 15px;">Painel de Indicadores</h2>

  <!-- Sele√ß√£o de Loja (apenas master) -->
  <div id="seletorLoja" style="display:none; margin:10px 0;">
    <label style="color:#7deaff;">Selecionar Loja:</label>
    <select id="selectLoja"></select>
  </div>

  <!-- Cards -->
  <div class="cards">
    <div class="card"><span class="icon">‚è≥</span><span class="number">0</span><span class="label">Perto de Vencer</span></div>
    <div class="card"><span class="icon">üìÖ</span><span class="number">0</span><span class="label">Vencendo Hoje</span></div>
    <div class="card"><span class="icon">‚ö†Ô∏è</span><span class="number">0</span><span class="label">Vencidos</span></div>
    <div class="card"><span class="icon">üì¶</span><span class="number">0</span><span class="label">Total de Produtos</span></div>
    <div class="card resumo-card"><span class="icon">üè∑Ô∏è</span><span class="number">0</span><span class="label">Resumo por Setor</span></div>
  </div>

</main>
  </div>

 <!-- Modal do Resumo por Setor (fora do app-container para n√£o bloquear layout) -->
  <div id="modalSetor" class="modal hidden" style="
    position: fixed; inset: 0;
    display: none; align-items: center; justify-content: center;
    backdrop-filter: blur(6px); background: rgba(0,0,0,0.55); z-index: 9999;">
    <div style="background:rgba(15,25,45,0.96); border:1px solid var(--accent);
                padding:20px; border-radius:12px; width:360px; max-width:90vw;">
      <h3 style="text-align:center;margin-bottom:12px;">Resumo por Setor</h3>
      <canvas id="graficoSetores" style="max-width:100%;"></canvas>
      <button id="fecharSetor" style="margin-top:15px;width:100%;padding:10px;
              border:none;border-radius:10px;background:var(--accent);
              color:#000;font-weight:700;cursor:pointer;">Fechar</button>
    </div>
  </div>

<script>
// --- Menu Hamb√∫rguer ---
const sidebar = document.querySelector('.sidebar');
const hamburger = document.createElement('button');
hamburger.className = 'hamburger';
hamburger.textContent = '‚ò∞';
hamburger.onclick = () => sidebar.classList.toggle('open');
document.body.appendChild(hamburger);

// --- Part√≠culas de Fundo ---
const canvas = document.getElementById('particleCanvas');
if(canvas){
  const ctx = canvas.getContext('2d');
  function resize(){ canvas.width = innerWidth; canvas.height = innerHeight; }
  window.addEventListener('resize', resize); resize();

  const particles = Array.from({length: 60}, () => ({
    x: Math.random()*canvas.width,
    y: Math.random()*canvas.height,
    r: Math.random()*2+1,
    sx: (Math.random()-0.5)*0.6,
    sy: (Math.random()-0.5)*0.6
  }));

  function animate(){
    ctx.clearRect(0,0,canvas.width,canvas.height);
    particles.forEach(p=>{
      p.x+=p.sx; p.y+=p.sy;
      if(p.x<0)p.x=canvas.width; if(p.x>canvas.width)p.x=0;
      if(p.y<0)p.y=canvas.height; if(p.y>canvas.height)p.y=0;
      ctx.fillStyle='rgba(255,255,255,0.07)';
      ctx.beginPath(); ctx.arc(p.x,p.y,p.r,0,Math.PI*2); ctx.fill();
    });
    requestAnimationFrame(animate);
  }
  animate();
}

// --- √çcones Neon Personalizados ---
document.querySelectorAll('.card .icon').forEach(el=>{
  el.style.filter = 'drop-shadow(0 0 8px rgba(0,119,255,0.8))';
});
</script>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
import { getFirestore, doc, getDoc, collection, getDocs } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";

const firebaseConfig = {
  apiKey: "AIzaSyDPIlkTLbaeUiuvfvijWf5fofREw5oE8ic",
  authDomain: "valitec-mj.firebaseapp.com",
  projectId: "valitec-mj",
  storageBucket: "valitec-mj.firebasestorage.app",
  messagingSenderId: "616592039657",
  appId: "1:616592039657:web:3827a890474111be85da78"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);

const cardPerto = document.querySelectorAll('.number')[0];
const cardHoje  = document.querySelectorAll('.number')[1];
const cardVencidos = document.querySelectorAll('.number')[2];
const cardTotal = document.querySelectorAll('.number')[3];
const cardSetor = document.querySelectorAll('.number')[4];

const lojasLista = [
  "loja_cd_cidade",
  "loja_cidade",
  "loja_terranova",
  "loja_manoa",
  "loja_zumbi",
  "loja_oswaldo",
  "loja_mosaico"
];

let lojaAtual = null;

async function carregarDashboard() {
  const user = auth.currentUser;
  if (!user) return;

  const userRef = doc(db, "usuarios", user.email);
  const snap = await getDoc(userRef);
  const cargo = snap.data().cargo;
  const loja = snap.data().loja;

  // Se for gerente ‚Üí s√≥ carrega a pr√≥pria loja
  if (cargo !== "master") {
    lojaAtual = loja;
    document.getElementById("selectLoja")?.remove();
  } else {
    // Se for MASTER ‚Üí libera sele√ß√£o
    document.getElementById("seletorLoja").style.display = "block";
    const select = document.getElementById("selectLoja");
    lojasLista.forEach(l => {
      const opt = document.createElement("option");
      opt.value = l;
      opt.textContent = l;
      select.appendChild(opt);
    });
    select.onchange = () => { lojaAtual = select.value; atualizar() };
    lojaAtual = lojasLista[0];
  }

  atualizar();
}

// Atualiza dados
async function atualizar() {
  const ref = collection(db, `lojas/${lojaAtual}/produtos`);
  const snap = await getDocs(ref);

  let total = 0;
  let hojeVence = 0;
  let vencidos = 0;
  let perto = 0;

  const hoje = new Date();

  snap.forEach(d => {
    const p = d.data();
    total++;
    const validade = new Date(p.dataValidadeISO);
    const diff = Math.ceil((validade - hoje) / (1000*60*60*24));

    if (diff < 0) vencidos++;
    else if (diff === 0) hojeVence++;
    else if (diff <= 7) perto++;
  });

  cardPerto.textContent = perto;
  cardHoje.textContent = hojeVence;
  cardVencidos.textContent = vencidos;
  cardTotal.textContent = total;
  cardSetor.textContent = "-"; // Pr√≥ximo passo ‚Üí gr√°fico por setor
}

onAuthStateChanged(auth, carregarDashboard);
let graficoSetores;

async function abrirResumoSetor() {
  const ref = collection(db, `lojas/${lojaAtual}/produtos`);
  const snap = await getDocs(ref);

  const contagem = {
    Mercearia: 0, Bebidas: 0, Frios: 0,
    Higiene: 0, Limpeza: 0, A√ßougue: 0
  };

  snap.forEach(d => {
    const p = d.data();
    if (contagem[p.setor] !== undefined) contagem[p.setor]++;
  });

  const ctx = document.getElementById("graficoSetoresModal");

  if (graficoSetores) graficoSetores.destroy();

  graficoSetores = new Chart(ctx, {
    type: "pie",
    data: {
      labels: Object.keys(contagem),
      datasets: [{
        data: Object.values(contagem),
        borderWidth: 3,
        borderColor: "#00eaff",
        backgroundColor: [
          "rgba(0,200,255,0.7)",
          "rgba(0,255,180,0.7)",
          "rgba(255,200,0,0.7)",
          "rgba(255,100,100,0.7)",
          "rgba(150,100,255,0.7)",
          "rgba(255,150,0,0.7)"
        ],
        hoverOffset: 10,
      }]
    },
    options: {
      plugins: {
        legend: {
          labels: { color: "white", font: { size: 14 } }
        }
      }
    }
  });

  document.getElementById("modalSetor").classList.remove("hidden");
}

document.querySelectorAll('.card')[4].onclick = abrirResumoSetor;
document.getElementById("fecharSetor").onclick = () => {
  document.getElementById("modalSetor").classList.add("hidden");
};
</script>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<button id="toggleTheme" class="theme-toggle">üåô</button>
<script>
const toggle = document.getElementById("toggleTheme");

function aplicarTema() {
  const tema = localStorage.getItem("temaValitec") || "dark";
  if (tema === "light") {
    document.documentElement.classList.add("light-mode");
    toggle.textContent = "üåô";
  } else {
    document.documentElement.classList.remove("light-mode");
    toggle.textContent = "üîÜ";
  }
}

toggle.onclick = () => {
  const atual = localStorage.getItem("temaValitec") || "dark";
  const novo = (atual === "dark") ? "light" : "dark";
  localStorage.setItem("temaValitec", novo);
  aplicarTema();
};

aplicarTema();
</script>
</body>
</html>
