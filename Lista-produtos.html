<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ValiTec MJ ‚Äî Lista de Produtos</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;500;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="dashboard.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.26/jspdf.plugin.autotable.min.js"></script>

</head>
<body>
  <canvas id="particleCanvas"></canvas>

  <div class="app-container">
    <aside class="sidebar">
      <h1></h1>
      <nav>
        <a href="dashboard.html">Painel</a>
        <a href="produto.html">cadastrar produtos</a>
        <a href="#" class="active">Lista de produtos</a>
        <a href="Lista-rebaixados.html">Produtos Rebaixados</a>
        <a href="calendario.html">Calendario</a>
        <a href="perfil.html">Perfil</a>
        <a href="cadastro-usuarios.html">Cadastrar Usu√°rios</a>
        <a href="relatorios.html">Relat√≥rios</a>
        <a href="#" onclick="localStorage.clear(); location.href='index.html'">Sair</a>
      </nav>
    </aside>

    <main class="main fade-in">
      <h2 class="page-title">Lista de Produtos</h2>

     

      <input type="text" id="busca" class="input-busca" placeholder="üîç Buscar por nome, setor ou c√≥digo...">

        <div class="export-container">
      <button id="exportTela" class="btnExport">üìÑ Exportar Tela (PDF/Excel)</button>
      <button id="exportTudo" class="btnExport">üóÇ Exportar  Tudo    (PDF/Excel)</button>
      </div>
      <!-- Lista -->
      <div id="listaProdutos" class="lista-produtos"></div>
    
    </main>
  </div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
  import { getFirestore, collection, getDocs, getDoc, doc, updateDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";
  import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";

  // === Bibliotecas para exporta√ß√£o ===
  import "https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js";
  import "https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js";
  import "https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.26/jspdf.plugin.autotable.min.js";

  let loja = null;
  let cargo = null;
  let produtosCarregados = [];
  let produtosCarregadosFiltrados = [];

  const firebaseConfig = {
    apiKey: "AIzaSyDPIlkTLbaeUiuvfvijWf5fofREw5oE8ic",
    authDomain: "valitec-mj.firebaseapp.com",
    projectId: "valitec-mj",
    storageBucket: "valitec-mj.firebasestorage.app",
    messagingSenderId: "616592039657",
    appId: "1:616592039657:web:3827a890474111be85da78"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  const auth = getAuth(app);

  async function carregarProdutos() {
    const user = auth.currentUser;
    if (!user) return;

    const userRef = doc(db, "usuarios", user.email);
    const userSnap = await getDoc(userRef);

    if (!userSnap.exists()) {
      document.getElementById('listaProdutos').innerHTML = "<div class='produto-card'>Usu√°rio sem perfil configurado.</div>";
      return;
    }

    loja  = userSnap.data().loja;
    cargo = userSnap.data().cargo;

    const ref = collection(db, `lojas/${loja}/produtos`);
    const snap = await getDocs(ref);

    produtosCarregados = [];
    snap.forEach(docItem => {
      const p = docItem.data();
      if (p.status === "rebaixado") return;
      produtosCarregados.push({ id: docItem.id, ...p });
    });

    exibirLista(produtosCarregados);
  }

  function exibirLista(listaProdutos) {
    const lista = document.getElementById('listaProdutos');
    lista.innerHTML = '';

    if (!listaProdutos.length) {
      lista.innerHTML = "<div class='produto-card'>Nenhum produto encontrado.</div>";
      return;
    }

    listaProdutos.forEach(p => {
      const item = document.createElement('div');
      item.className = 'produto-card';

      const fotoSrc = p.fotoURL || "";
      item.innerHTML = `
        <img src="${fotoSrc}" style="width:70px;height:70px;object-fit:cover;border-radius:6px;" onerror="this.style.display='none'">
        <div style="flex:1;">
          <strong>${p.nome || "-"}</strong><br>
          ${p.setor || "-"}<br>
          Validade: ${p.dataValidadeBR || "-"}
        </div>
      `;

      // === Bot√£o WhatsApp ===
      const btnWhats = document.createElement("button");
      btnWhats.textContent = "üü¢ WhatsApp";
      btnWhats.className = "btnWhats";
      btnWhats.onclick = async () => {
        try {
          const perfil = await getDoc(doc(db, "gerentes", auth.currentUser.email));
          const numero = perfil.data()?.whatsResponsavel || "";
          const msg = `‚ö†Ô∏è *Rebaixa Solicitada*\n\nProduto: ${p.nome}\nValidade: ${p.dataValidadeBR}`;
          window.open(`https://wa.me/55${numero}?text=${encodeURIComponent(msg)}`);
        } catch (e) {
          alert("N√£o foi poss√≠vel abrir o WhatsApp.");
          console.error(e);
        }
      };
      item.appendChild(btnWhats);

      // === Diferen√ßa de dias para cor ===
      const diff = Math.ceil((new Date(p.dataValidadeISO) - new Date()) / 86400000);
      const cor = (diff <= 5) ? "#ff4d4d" :
                  (diff <= 10) ? "#ff9f43" :
                  (diff <= 15) ? "#ffe66d" : "#4eff9a";

      // === Bot√£o Rebaixar ===
      const btnConfirm = document.createElement("button");
      btnConfirm.textContent = `‚úÖ Rebaixar (${isNaN(diff) ? "-" : diff}d)`;
      btnConfirm.style.background = cor;
      btnConfirm.style.color = "#000";
      btnConfirm.style.padding = "8px 10px";
      btnConfirm.style.borderRadius = "6px";
      btnConfirm.style.fontWeight = "600";
      btnConfirm.style.cursor = "pointer";

      btnConfirm.onclick = async () => {
        try {
          await updateDoc(doc(db, `lojas/${loja}/produtos/${p.id}`), { status: "rebaixado" });

          const confSnap = await getDoc(doc(db, `lojas/${loja}/config/geral`));
          const gerenteWhats = confSnap.exists() ? confSnap.data().whatsGerente : null;

          if (gerenteWhats) {
            const msg = `üìâ *PRODUTO REBAIXADO*\n\nüì¶ *${p.nome}*\nüè∑Ô∏è Setor: ${p.setor}\nüîñ Lote: ${p.lote}\nüìÖ Validade: ${p.dataValidadeBR}`;
            window.open(`https://wa.me/55${gerenteWhats}?text=${encodeURIComponent(msg)}`);
          }

          carregarProdutos();
        } catch (e) {
          alert("‚ùå Erro ao rebaixar o produto.");
          console.error(e);
        }
      };
      item.appendChild(btnConfirm);

      // === Editar / Excluir (para gerente ou auxiliar) ===
      if (cargo !== "responsavel") {
        const btnEditar = document.createElement("button");
        btnEditar.textContent = "‚úèÔ∏è Editar";
        btnEditar.className = "btnEdit";
        btnEditar.onclick = () => location.href = `produto.html?id=${p.id}`;
        item.appendChild(btnEditar);

        const btnExcluir = document.createElement("button");
        btnExcluir.textContent = "üóëÔ∏è Excluir";
        btnExcluir.className = "btnDelete";
        btnExcluir.style.background = "#ff6b6b";
        btnExcluir.style.color = "#000";
        btnExcluir.onclick = async () => {
          if (!confirm(`Excluir ${p.nome}?`)) return;
          try {
            await deleteDoc(doc(db, `lojas/${loja}/produtos/${p.id}`));
            carregarProdutos();
          } catch (e) {
            alert("Falha ao excluir.");
            console.error(e);
          }
        };
        item.appendChild(btnExcluir);
      }

      lista.appendChild(item);
    });
  }

  // ===== FILTRO DE BUSCA =====
  document.getElementById("busca").addEventListener("input", e => {
    const termo = e.target.value.toLowerCase();
    produtosCarregadosFiltrados = produtosCarregados.filter(p =>
      (p.nome || "").toLowerCase().includes(termo) ||
      (p.setor || "").toLowerCase().includes(termo) ||
      (p.codigo || "").toLowerCase().includes(termo)
    );
    exibirLista(produtosCarregadosFiltrados);
  });

  // ===== EXPORTAR TELA OU TODOS =====
  document.getElementById("exportTela").onclick = () => {
    exportar(produtosCarregadosFiltrados.length ? produtosCarregadosFiltrados : produtosCarregados);
  };

  document.getElementById("exportTudo").onclick = async () => {
    const ref = collection(db, `lojas/${loja}/produtos`);
    const snap = await getDocs(ref);
    const todos = [];
    snap.forEach(d => todos.push({ id: d.id, ...d.data() }));
    exportar(todos);
  };

  // ===== FUN√á√ÉO DE EXPORTA√á√ÉO =====
  function exportar(lista) {
    if (!lista.length) return alert("Nenhum produto para exportar.");

    // --- Excel ---
    const ws = XLSX.utils.json_to_sheet(lista.map(p => ({
      Nome: p.nome,
      Lote: p.lote,
      Setor: p.setor,
      Validade: p.dataValidadeBR
    })));
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "Produtos");
    XLSX.writeFile(wb, "produtos_valitec.xlsx");

    // --- PDF ---
    const { jsPDF } = window.jspdf;
    const pdf = new jsPDF();
    pdf.text("Lista de Produtos - ValiTec MJ", 14, 12);
    pdf.autoTable({
      startY: 18,
      head: [["Nome", "Setor", "Lote", "Validade"]],
      body: lista.map(p => [p.nome, p.setor, p.lote, p.dataValidadeBR])
    });
    pdf.save("produtos_valitec.pdf");
  }

  onAuthStateChanged(auth, carregarProdutos);
</script>


  <script>
  // Part√≠culas
  const canvas = document.getElementById("particleCanvas");
  const ctx = canvas.getContext("2d");

  let particles = [];
  let w, h;

  function resize() {
    w = canvas.width = window.innerWidth;
    h = canvas.height = window.innerHeight;
  }
  window.addEventListener("resize", resize);
  resize();

  for (let i = 0; i < 60; i++) {
    particles.push({
      x: Math.random() * w,
      y: Math.random() * h,
      r: Math.random() * 2 + 1,
      dx: (Math.random() - 0.5) * 0.4,
      dy: (Math.random() - 0.5) * 0.4
    });
  }

  function draw() {
    ctx.clearRect(0, 0, w, h);
    ctx.fillStyle = "rgba(0, 200, 255, 0.35)";

    particles.forEach(p => {
      ctx.beginPath();
      ctx.arc(p.x, p.y, p.r, 0, Math.PI * 2);
      ctx.fill();
    });

    connectParticles();
    updateParticles();
    requestAnimationFrame(draw);
  }

  function updateParticles() {
    particles.forEach(p => {
      p.x += p.dx;
      p.y += p.dy;

      if (p.x < 0 || p.x > w) p.dx *= -1;
      if (p.y < 0 || p.y > h) p.dy *= -1;
    });
  }

  function connectParticles() {
    ctx.strokeStyle = "rgba(0, 200, 255, 0.10)";
    ctx.lineWidth = 1;

    for (let i = 0; i < particles.length; i++) {
      for (let j = i + 1; j < particles.length; j++) {
        let dist = Math.hypot(particles[i].x - particles[j].x, particles[i].y - particles[j].y);
        if (dist < 130) {
          ctx.globalAlpha = 1 - dist / 130;
          ctx.beginPath();
          ctx.moveTo(particles[i].x, particles[i].y);
          ctx.lineTo(particles[j].x, particles[j].y);
          ctx.stroke();
        }
      }
    }
    ctx.globalAlpha = 1;
  }

  draw();
  </script>

  <script>
  // Menu hamb√∫rguer
  const sidebar = document.querySelector('.sidebar');
  const hamburger = document.createElement('button');
  hamburger.className = 'hamburger';
  hamburger.textContent = '‚ò∞';
  hamburger.onclick = () => sidebar.classList.toggle('open');
  document.body.appendChild(hamburger);
  </script>

  <button id="toggleTheme" class="theme-toggle">üåô</button>
  <script>
  const toggle = document.getElementById("toggleTheme");

  function aplicarTema() {
    const tema = localStorage.getItem("temaValitec") || "dark";
    if (tema === "light") {
      document.documentElement.classList.add("light-mode");
      toggle.textContent = "üåô";
    } else {
      document.documentElement.classList.remove("light-mode");
      toggle.textContent = "üîÜ";
    }
  }

  toggle.onclick = () => {
    const atual = localStorage.getItem("temaValitec") || "dark";
    const novo = (atual === "dark") ? "light" : "dark";
    localStorage.setItem("temaValitec", novo);
    aplicarTema();
  };

  aplicarTema();
  </script>
</body>
</html>
